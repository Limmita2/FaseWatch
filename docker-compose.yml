services:
  qdrant:
    image: qdrant/qdrant:latest
    container_name: facewatch_qdrant
    restart: always
    ports:
      - "127.0.0.1:6333:6333"
    volumes:
      - qdrant_data:/qdrant/storage
    environment:
      - QDRANT__STORAGE__OPTIMIZERS__MEMMAP_THRESHOLD=20000

  redis:
    image: redis:alpine
    container_name: facewatch_redis
    restart: always
    command: redis-server --maxmemory 256mb --maxmemory-policy allkeys-lru

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: facewatch_backend
    restart: always
    expose:
      - "8000"
    env_file: .env
    environment:
      - DATABASE_URL=mysql+aiomysql://${MARIADB_USER:-facewatch}:${MARIADB_PASSWORD:-ke050442}@${MARIADB_HOST:-192.168.24.178}:${MARIADB_PORT:-3306}/${MARIADB_DB:-facewatch_db}
      - QDRANT_HOST=qdrant
      - QDRANT_PORT=6333
      - REDIS_URL=redis://redis:6379/0
      - QNAP_MOUNT_PATH=/mnt/qnap_photos
      - TZ=Europe/Kyiv
      - PYTHONUNBUFFERED=1
      - SEARCH_ORT_THREADS=8
    volumes:
      - /mnt/qnap_photos:/mnt/qnap_photos
    depends_on:
      qdrant:
        condition: service_started
      redis:
        condition: service_started

  celery_worker:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: facewatch_celery
    restart: always
    command: celery -A app.worker.celery_app worker --loglevel=info --concurrency=8 --pool=prefork
    env_file: .env
    environment:
      - DATABASE_URL=mysql+aiomysql://${MARIADB_USER:-facewatch}:${MARIADB_PASSWORD:-ke050442}@${MARIADB_HOST:-192.168.24.178}:${MARIADB_PORT:-3306}/${MARIADB_DB:-facewatch_db}
      - QDRANT_HOST=qdrant
      - QDRANT_PORT=6333
      - REDIS_URL=redis://redis:6379/0
      - QNAP_MOUNT_PATH=/mnt/qnap_photos
      - TZ=Europe/Kyiv
      - PYTHONUNBUFFERED=1
      - ORT_INTRA_THREADS=6
      - ORT_INTER_THREADS=2
      - OMP_NUM_THREADS=6
      - MKL_NUM_THREADS=6
      - OPENBLAS_NUM_THREADS=6
    volumes:
      - /mnt/qnap_photos:/mnt/qnap_photos
    depends_on:
      - backend
      - redis

  bot:
    build:
      context: ./bot
      dockerfile: Dockerfile
    container_name: facewatch_bot
    restart: always
    env_file: .env
    environment:
      - BACKEND_API_URL=http://backend:8000
      - TZ=Europe/Kyiv
      - PYTHONUNBUFFERED=1
    depends_on:
      - backend

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: facewatch_frontend
    restart: always
    ports:
      - "3000:80"
    depends_on:
      - backend

volumes:
  qdrant_data:
