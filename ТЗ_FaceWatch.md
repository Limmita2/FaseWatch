# Технічне завдання: FaceWatch — система моніторингу Telegram-каналів з розпізнаванням облич

**Версія:** 1.0  
**Дата:** 23.02.2026  
**Мова інтерфейсу:** Українська

---

## 1. Загальний опис системи

FaceWatch — це вебзастосунок для збору, зберігання та аналізу медіаконтенту (фото + текст) із Telegram-каналів і груп. Основна функція — автоматичне розпізнавання облич на фотографіях, збереження їхніх векторних представлень у базі даних та пошук збігів за фото або текстом.

---

## 2. Стек технологій

| Компонент | Технологія | Обґрунтування |
|---|---|---|
| Фронтенд | React (TypeScript) | Вимога замовника |
| Бекенд | Python, FastAPI | Найкраща екосистема для ML-задач |
| Векторна БД | **Qdrant** | Оптимальна для 10M+ векторів, проста установка через Docker/CLI, повнотекстовий пошук |
| Реляційна БД | PostgreSQL | Метадані, користувачі, групи, повідомлення |
| Розпізнавання облич | **InsightFace (ArcFace)** | Найвища точність серед open-source рішень, підтримка CPU без GPU |
| Зберігання файлів | QNAP NAS (SMB) | Вимога замовника: 192.168.24.78 |
| Telegram-бот | python-telegram-bot / aiogram | Збір даних із ~100 груп |
| Черга задач | Celery + Redis | Асинхронна обробка фото |
| Контейнеризація | Docker Compose | Спрощене розгортання всіх сервісів |

---

## 3. Архітектура системи

```
Telegram-групи (до 100)
        ↓
  Telegram-боти (адміни в групах)
        ↓
  FastAPI Backend (Ubuntu-сервер)
        ↓
  ┌─────────────────────────────────┐
  │  Celery Worker                  │
  │  - завантаження фото на QNAP    │
  │  - InsightFace: детекція облич  │
  │  - генерація векторів 512-dim   │
  └─────────────────────────────────┘
        ↓                    ↓
   Qdrant                PostgreSQL
   (вектори облич)       (метадані)
        ↑
  React Веб-інтерфейс
  - пошук за фото
  - пошук за текстом
  - управління особами
```

---

## 4. Модулі системи

### 4.1 Telegram-бот

- Один бот-токен може обслуговувати до 100 груп (рекомендовано 2–3 боти для надійності)
- Бот повинен мати права адміністратора в кожній групі
- Кожне повідомлення (текст + медіа) передається в чергу обробки через Webhook
- Фіксуються: `group_id`, `group_name`, `message_id`, `sender_id`, `timestamp`, `text`, `photo`

### 4.2 Обробка фотографій

1. Фото зберігається на QNAP через SMB-монтування (`/mnt/qnap/`)
2. Структура папок на QNAP:
   ```
   /photos/
     {group_id}/
       {YYYY-MM}/
         {message_id}_{timestamp}.jpg
   /backup_imports/
     {import_session_id}/
       ...
   ```
3. InsightFace детектує всі обличчя на фото
4. Для кожного обличчя генерується вектор 512 вимірів (ArcFace embedding)
5. Вектори зберігаються в Qdrant
6. Мініатюра обличчя (crop) зберігається на QNAP: `/faces/{person_id}/`

### 4.3 Ідентифікація особи (гібридний режим)

- При надходженні нового обличчя — автоматичний пошук у Qdrant (cosine similarity)
- Якщо схожість **> 0.75** — пропонується автоматичне з'єднання з існуючою особою (потребує підтвердження оператора)
- Якщо схожість **< 0.75** — створюється нова особа з унікальним ID
- Оператор підтверджує або відхиляє кожне автоматичне з'єднання в інтерфейсі
- Ім'я особи: береться з підпису під фото в Telegram. Якщо підпису немає — відображається лише внутрішній ID

### 4.4 Імпорт резервної копії Telegram

**Формат файлу:** стандартний експорт Telegram Desktop — ZIP-архів із такою структурою:
```
Назва групи/
  messages.html      ← усі повідомлення
  photos/            ← фотографії (photo_32@10-01-2022_13-24-55.jpg)
  css/, js/, images/ ← допоміжні файли (ігноруються)
```

**Структура HTML та логіка парсингу:**

Telegram Desktop експортує два типи повідомлень:
- `message default clearfix` — перше повідомлення серії: містить `from_name`, аватар, час
- `message default clearfix joined` — продовження від того ж відправника (без `from_name`)

Атрибути кожного повідомлення:
- `id="message232753"` — унікальний ID
- `title="10.01.2022 13:24:55 UTC+02:00"` — точна дата і час
- `from_name` — ім'я відправника (лише в першому повідомленні серії)
- `photo_wrap href` — відносний шлях до фото (`photos/photo_32@....jpg`)
- `.text` — текстовий вміст

**Ключова особливість даних цього типу каналів:**

Кожне повідомлення зберігається **окремо** — фото окремо, текст окремо. Парсер не об'єднує їх і не робить припущень щодо зв'язків між повідомленнями. Структура може бути різною в різних групах: іноді фото і підпис поруч, іноді — ні.

Зв'язок між фото і текстом оператор бачить самостійно через контекст (повідомлення до і після).

**Процес імпорту:**
1. Завантаження ZIP-архіву через веб-інтерфейс (drag & drop)
2. Вибір існуючої групи або введення назви нової
3. Парсинг `messages.html` (BeautifulSoup4) зі збереженням порядку та зв'язків
4. Фото → збереження на QNAP → черга Celery → InsightFace → вектори → Qdrant
5. Прогрес-бар у реальному часі (Server-Sent Events)
6. Звіт після завершення: кількість повідомлень, фото, виявлених облич, нових осіб

---

## 5. База даних

### PostgreSQL — схема таблиць

```sql
-- Групи Telegram
groups (
  id UUID PK,
  telegram_id BIGINT UNIQUE,
  name TEXT,
  created_at TIMESTAMP
)

-- Повідомлення
messages (
  id UUID PK,
  group_id UUID FK,
  telegram_message_id BIGINT,
  sender_telegram_id BIGINT,
  text TEXT,
  has_photo BOOLEAN,
  photo_path TEXT,          -- шлях на QNAP
  timestamp TIMESTAMP,
  imported_from_backup BOOLEAN DEFAULT FALSE,
  created_at TIMESTAMP
)

-- Особи
persons (
  id UUID PK,
  display_name TEXT,        -- ім'я з підпису або NULL
  created_at TIMESTAMP,
  confirmed BOOLEAN DEFAULT FALSE
)

-- Обличчя (кожне виявлене обличчя)
faces (
  id UUID PK,
  person_id UUID FK,        -- NULL якщо ще не ідентифіковано
  message_id UUID FK,
  crop_path TEXT,           -- мініатюра на QNAP
  qdrant_point_id UUID,     -- ID вектора в Qdrant
  bbox JSONB,               -- координати bounding box
  confidence FLOAT,
  created_at TIMESTAMP
)

-- Черга підтверджень (гібридна ідентифікація)
identification_queue (
  id UUID PK,
  face_id UUID FK,
  suggested_person_id UUID FK,
  similarity FLOAT,
  status ENUM('pending','confirmed','rejected'),
  reviewed_by UUID FK,
  reviewed_at TIMESTAMP,
  created_at TIMESTAMP
)

-- Користувачі системи
users (
  id UUID PK,
  username TEXT UNIQUE,
  password_hash TEXT,
  role ENUM('admin','operator'),
  created_at TIMESTAMP
)
```

### Qdrant — колекції

```
collection: faces
  vector size: 512
  distance: Cosine
  payload: { face_id, person_id, message_id, group_id, timestamp }
```

---

## 6. Веб-інтерфейс (React)

### 6.1 Аутентифікація
- Логін/пароль (JWT-токени)
- Ролі: **admin** (повний доступ), **operator** (перегляд + підтвердження ідентифікацій)

### 6.2 Дашборд
- Статистика: кількість груп, повідомлень, облич, осіб у базі
- Останні надходження (стрічка з джерелом і часом)
- Черга підтверджень ідентифікацій (кількість pending)

### 6.3 Стрічка повідомлень
- Фільтри: по групі, по даті, тільки з фото
- Кожне повідомлення показує: значок групи, назву групи, час, текст, фото
- Кліком на обличчя відкривається картка особи

### 6.4 Пошук за фото

**Завантаження фото:**
- Drag & drop або вибір файлу
- Детекція всіх облич на завантаженому фото
- Якщо кілька облич — вибір конкретного для пошуку (клік по bounding box)

**Відображення результатів (top-5 збігів):**

Кожен результат відображається у вигляді **картки збігу**:

```
┌─────────────────────────────────────────────────────────┐
│  [crop обличчя]   Схожість: 94%   Особа: ID / Ім'я      │
│                                                          │
│  ── Джерело: Telegram-група ──                          │
│                                                          │
│  [повідомлення -2]  17:21  Текст попереднього...        │
│  [повідомлення -1]  17:22  Текст попереднього...        │
│  ┌─────────────────────────────────────────────────┐    │
│  │ ★ [ФОТО зі збігом]  17:23  Назва групи         │    │
│  │   підпис під фото якщо є                        │    │
│  └─────────────────────────────────────────────────┘    │
│  [повідомлення +1]  17:24  Текст наступного...          │
│  [повідомлення +2]  17:25  Текст наступного...          │
│                                                          │
│  ── Якщо завантажено користувачем напряму ──            │
│  [crop обличчя]  Схожість: 91%  |  Коментар оператора  │
└─────────────────────────────────────────────────────────┘
```

**Логіка контексту:**
- Якщо фото з **Telegram-бекапу або живого бота**: показуються 2 повідомлення до і 2 після в межах тієї ж групи (відсортовані за `timestamp`)
- Якщо фото завантажено **оператором напряму** через веб-інтерфейс: показується лише коментар/підпис, який оператор ввів при завантаженні

**Додаткові дії в картці:**
- Кнопка "Відкрити повне повідомлення"
- Кнопка "Зберегти в базу" (якщо завантажене фото — нова особа)
- Поле для введення підпису/коментаря перед збереженням

### 6.5 Пошук за текстом
- Повнотекстовий пошук по полю `text` повідомлень (PostgreSQL Full-Text Search)
- Результати: список повідомлень із підсвіченням знайденого тексту
- Клік на результат — відкриває повне повідомлення з контекстом (2 до / 2 після)

### 6.6 Картка особи
- Усі фото-збіги особи у вигляді сітки (crop обличчя + мініатюра оригінального фото)
- Поле `display_name` — якщо є в підписі телеграм-повідомлення, інакше тільки ID
- При кліці на будь-яке фото — розгортається контекст повідомлень (2 до / 2 після)
- Кнопка "Об'єднати з іншою особою" (адмін)
- Кнопка "Роз'єднати обличчя" (адмін)

### 6.7 Черга ідентифікацій
- Список pending: ліворуч нове обличчя, праворуч запропонована особа, score подібності
- Під кожним — контекст з якої групи і з якого повідомлення прийшло обличчя
- Кнопки: ✓ Підтвердити / ✗ Відхилити / Вибрати іншу особу

### 6.8 Імпорт резервної копії
- Drag & drop ZIP-архіву (структура: `Назва групи/messages.html + photos/`)
- Вибір існуючої групи або введення назви нової
- Прогрес-бар у реальному часі: "Парсинг HTML → Завантаження фото → Розпізнавання облич"
- Звіт після завершення: кількість повідомлень, фото, виявлених облич, нових осіб

### 6.9 Управління групами (admin)
- Список підключених Telegram-груп
- Статус бота в кожній групі (активний/неактивний)
- Дата останнього повідомлення

### 6.10 Управління користувачами (admin)
- Додавання/видалення операторів
- Зміна паролів

---

## 7. API (FastAPI)

| Метод | Endpoint | Опис |
|---|---|---|
| POST | `/webhook/{bot_token}` | Отримання повідомлень від Telegram |
| POST | `/api/search/face` | Пошук за фото |
| GET | `/api/search/text?q=...` | Пошук за текстом |
| GET | `/api/messages` | Список повідомлень (з фільтрами) |
| GET | `/api/persons` | Список осіб |
| GET | `/api/persons/{id}` | Картка особи |
| PATCH | `/api/persons/{id}` | Оновлення особи |
| POST | `/api/persons/merge` | Об'єднання осіб |
| GET | `/api/queue` | Черга ідентифікацій |
| POST | `/api/queue/{id}/confirm` | Підтвердити ідентифікацію |
| POST | `/api/queue/{id}/reject` | Відхилити ідентифікацію |
| POST | `/api/import` | Завантаження резервної копії |
| GET | `/api/groups` | Список груп |
| POST | `/api/auth/login` | Авторизація |

---

## 8. Розгортання (Ubuntu Server)

### 8.1 Вимоги до сервера
- OS: Ubuntu 22.04 LTS
- RAM: мінімум 16 ГБ (рекомендовано 32 ГБ для 10M+ векторів)
- CPU: 8+ ядер (без GPU — InsightFace працює на CPU)
- Диск: 50 ГБ для ОС + БД (фото — на QNAP)
- Мережа: доступ до QNAP за адресою 192.168.24.78

### 8.2 Docker Compose сервіси
```yaml
services:
  postgres:        # PostgreSQL 15
  qdrant:          # Qdrant (остання стабільна версія)
  redis:           # Redis (черга Celery)
  backend:         # FastAPI
  celery_worker:   # Celery обробник фото
  frontend:        # React (Nginx)
```

### 8.3 Монтування QNAP
```bash
# /etc/fstab
//192.168.24.78/share /mnt/qnap cifs credentials=/etc/qnap-creds,uid=1000,gid=1000 0 0
```

### 8.4 Встановлення Qdrant (CLI без Docker)
```bash
curl -L https://github.com/qdrant/qdrant/releases/latest/download/qdrant-x86_64-unknown-linux-gnu.tar.gz -o qdrant.tar.gz
tar -xzf qdrant.tar.gz
./qdrant --config-path config.yaml
```

---

## 9. Безпека

- Паролі зберігаються як bcrypt-хеші
- JWT-токени з терміном дії 8 годин
- HTTPS (Let's Encrypt або self-signed для локальної мережі)
- Telegram Webhook — перевірка підпису запиту
- Облікові дані QNAP — у файлі `/etc/qnap-creds` із правами 600
- **Важливо:** Облікові дані QNAP, що були вказані у відкритому вигляді, необхідно змінити

---

## 10. Обмеження та примітки

- GPU відсутній → InsightFace працює на CPU. Обробка 1 фото ~1–3 сек. При пікових навантаженнях потрібно масштабувати кількість Celery workers
- Qdrant з 10M+ векторами по 512 вимірів потребує ~20–25 ГБ RAM для оптимальної роботи (або увімкнути mmap для роботи з диском)
- Імпорт великих резервних копій (~100K фото) може тривати кілька годин — реалізується у фоновому режимі
- Один Telegram-бот може бути адміном у необмеженій кількості груп

---

## 11. Черговість розробки (рекомендована)

1. **Фаза 1:** Інфраструктура — Docker Compose, PostgreSQL, Qdrant, QNAP-монтування
2. **Фаза 2:** Telegram-бот → прийом повідомлень → збереження на QNAP
3. **Фаза 3:** InsightFace pipeline → вектори → Qdrant
4. **Фаза 4:** FastAPI — всі ендпоінти
5. **Фаза 5:** React — базовий інтерфейс (стрічка, пошук)
6. **Фаза 6:** Гібридна ідентифікація + черга підтверджень
7. **Фаза 7:** Імпорт резервних копій
8. **Фаза 8:** Тестування, оптимізація продуктивності
